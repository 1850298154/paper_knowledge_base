\beginbass
%
At the beginning on \Cref{sec:ts_bin_corr} we informally introduced the
\emph{measure} of a process as a lexicographically ordered pair $(m, n)$ 
where the two component refer to \emph{past} and \emph{future}, respectively.
To distinguish between past and future ofa process $P$ we look at its structure: all
sessions that occur unguarded in $P$ have been created and are not terminated;
all casts that occur in $P$ are yet to be performed; all sessions that occur
guarded in $P$ have not been created yet.
%
First, we need to formalize the notion of \emph{rank} of a session which represents
the minimum effort for reaching termination.

\begin{definition}[rank]
  \label{def:rank_bin}
  The \emph{rank} of $S$ and $T$, written $\rankb\S\T$, is the element of $\Nat
  \cup \set\infty$ defined as
  \[
    \rankb\S\T \eqdef \min\set{ 1 + |\actions| \mid \exists\actions, \Pol: S \wlred{\co\actions} \End[\co\Pol], T \wlred\actions \End[\Pol] }
  \]
  where $|\actions|$ denotes the length of $\actions$, $\co\actions$ is the
  string of actions obtained by dualizing all the actions in $\actions$, and we
  postulate that $\min\emptyset = \infty$.
\end{definition}

Note that the rank $\rankb\S\T$ is generally unrelated to the lengths of the
shortest paths of $S$ and $T$ that lead to termination. For example, if we take
$S = \In\la.\Out\lc.\In\la.\End[\In] \branch \In\lb.\End[\In]$ and $T =
\Out\la.(\In\lc.\Out\la.\End[\Out] \branch \In\ld.\End[\Out])$ we see that the
shortest path $\actionsA$ such that $S(\actionsA) = \End[\In]$ is $\In\lb$ of
length 1 and the shortest path $\actionsB$ such that $T(\actionsB) = \End[\Out]$
is $\Out\la\In\ld$ of length 2, but $\rankb\S\T = 4$. Indeed, both $S$ and $T$ must
reach termination; so we have to consider the exchange of labels $\la,\lc,\la$ and 
increment by one according to \Cref{def:rank_bin}.

\begin{theorem}
    \label{thm:rank_bin}
    If $U \compatible S$, then
    \begin{enumerate}
    	\item\label{item:rank_finite} $\rankb\U\S \in \Nat$ and
    	\item\label{item:rank_subt} $S \csubt T$ implies $\rankb\U\S \leq \rankb\U\T$.
    \end{enumerate}
\end{theorem}
\begin{proof}
    \Cref{item:rank_finite} follows from the observation that $U \compatible S$
    implies $\Sys\U\S \wred \Sys{\End[\co\Pol]}{\End[\Pol]}$ for some $\Pol$, hence there exists $\actions$
    such that $U \wlred{\co\actions} \End[\co\Pol]$ and $S \wlred\actions
   	\End[\Pol]$.
    %
    \Cref{item:rank_subt} is trivial to prove if we establish that
    \[
        \set{ \actions \mid U \wlred{\co\actions}, T \wlred\actions }
        \subseteq
        \set{ \actions \mid U \wlred{\co\actions}, S \wlred\actions }
    \]
    under the hypotheses $U \compatible S$ and $S \csubt T$.
    %
    We prove that $U \wlred{\co\actions}$ and $T \wlred\actions$ implies $S
    \wlred\actions$ by induction on $\actions$ and by cases on its first action.
    
    The base case $\actions = \es$ is trivial.
    %
    If $\actions = \Pol\V\actionsB$, then $T = \Pol\V.T'$ for some $T'$ and by definition of 
    $\csubt$ we deduce $S = \Pol\V.S'$ and $S' \csubt T'$ for some $S'$. 
    From $U \compatible S$ we deduce $U = \co\\Pol\V.U'$ for some $U' \compatible S'$.
    %
    Using the induction hypothesis we obtain $S' \wlred\actionsB$, which is enough to conclude $S \wlred\actions$.
    
    If $\actions = \Out\l\actionsB$, then $T = \Choice{l_j:T_j}_{j\in J}$ and $l
    = l_k$ for some $k\in J$. By definition of $\csubt$ we deduce $S = \Choice{l_i:S_i}_{i\in I}$ for some $I \supseteq J$, 
    hence $S \wlred{\Out\l}$.
    %
    From $U \compatible S$ we deduce $U = \Branch{l_k:U_k}_{k\in K}$ for some $K \supseteq I$ and $U_k \compatible S_k$.
    %
    Using the induction hypothesis we obtain $S_k \wlred\actionsB$, from which we conclude $S \wlred\actions$.

    If $\actions = \In\l\actionsB$, then $T = \Branch{l_j:T_j}_{j\in J}$ and $l = l_k$ for some $k\in J$. 
    By definition of $\csubt$ we deduce $S = \Branch{l_i:S_i}_{i\in I}$ for some $I \subseteq J$.
    %
    From $U \compatible S$ we deduce $U = \Choice{l_k:U_k}_{k\in K}$ for some $K \subseteq I$. 
    Also, it must be the case that $k\in K$ and $U_k \compatible S_k$.
    %
    Using the induction hypothesis we obtain $S_k \wlred\actionsB$, from which we conclude $S \wlred\actions$.
\end{proof}

\Cref{thm:rank_bin} shows that every usage of (fair) subtyping may increase the
amount of work that is necessary to terminate a session (\Cref{item:rank_subt}),
although such amount is guaranteed to remain finite as long as compatibility is
preserved (\Cref{item:rank_finite}). This property justifies the adoption of
fair subtyping over unfair subtyping, since fair subtyping preserves
compatibility whereas unfair subtyping in general does not (\Cref{ssec:unfair_sub}).

To compute the measure of a process, we introduce three refined typing rules to
derive judgments of the form $\wtpn\Measure\Ctx{P}$, stating that $P$ is
well typed in $\Ctx$ and has measure $\Measure$.
Such rules are shown in \Cref{fig:measure_bin}.

\begin{figure}[t]
	\framebox[\linewidth]{
	\begin{mathpar}
	\inferrule[mtb-thread]{
        \wtp[n]\Ctx{P}
    }{
        \wtpn{(n, 0)}\Ctx{P}
    } \defrule[mtb-thread]{}
    \and
    \inferrule[mtb-cast]{
        \wtpn\Measure{\Ctx, x : T}{P}
    }{
        \wtpn{\Measure + (m,0)}{\Ctx, x : S}{\Cast\x P}
    }
    ~
    S \subt[m] T \defrule[mtb-cast]{}
    \and
    \inferrule[mtb-par]{
        \wtpn{\MeasureM}{\Ctx, x : S}{P}
        \\
        \wtpn{\MeasureN}{\CtxD, x : T}{P}
    }{
        \wtpn{\MeasureM + \MeasureN + (0, \rankb{S}{T})}{
            \Ctx, \CtxD
        }{
            \NewPar\x{P}{Q}
        }
    }
    ~
    S \compatible T \defrule[mtb-par]{}
	\end{mathpar}
	}
	\caption{Typing rules with measure}
	\label{fig:measure_bin}
\end{figure}

Rule \refrule{mtb-thread} has \emph{lower priority} than \refrule{mtb-par} and
\refrule{mtb-cast}, in the sense that it applies only to processes that are not a
cast or a parallel composition. We call such processes \emph{threads} and their
measure is solely determined by their rank: every cast occurring in a thread is
yet to be performed and every session occurring in a thread is yet to be created.
%
Rule \refrule{mtb-par} states that the measure of a parallel composition is the
(pointwise) sum of the measures of the composed processes, taking into account
the rank of the session $x$ by which they are connected.
%
Finally, \refrule{mtb-cast} states that the measure of a cast is the same measure
of the process in which the cast has effect, but with the first component
increased by one to account for the fact that the cast is yet to be performed.

Note that, as a well-typed process reduces, its measure may vary arbitrarily. In
particular, its measure \emph{may increase} if the process chooses to create new
sessions (see the left choice of process $C$ in \Cref{ex:infinite_sessions}) or
if it picks a label that lengthens the shortest path leading to session
termination (see \Cref{ex:bsc_bin_reduction}).

\begin{lemma}
    \label{lem:measure_rank_bin}
    The following properties hold:
    \begin{enumerate}
        \item $\wtp[n]\Ctx{P}$ implies $\wtpn\Measure\Ctx{P}$ for some
        $\Measure \leq (n, 0)$;
        \item $\wtpn\Measure\Ctx{P}$ implies $\wtp[n]\Ctx{P}$ for some $n$ such that $\Measure \leq (n, 0)$.
    \end{enumerate}
\end{lemma}
\begin{proof}
    We prove item 1 by induction on the structure of $P$ and
    by cases on the last rule applied. The proof of item 2 is by induction over
    $\wtpn\Measure\Ctx{P}$.

    \proofcase{Case $P = \NewPar\x{P_1}{P_2}$}
    %
    Then from \refrule{tb-par} we deduce that there exist $\Ctx_1$, $\Ctx_2$,
    $S_1$, $S_2$, $n_1$, $n_2$ such that:
    \begin{itemize}
    \item $\Ctx = \Ctx_1, \Ctx_2$
    \item $\wtp[n_i]{\Ctx_i, x : S_i}{P_i}$ for $i=1,2$
    \item $S_1 \compatible S_2$
    \item $n = 1 + n_1 + n_2$
    \end{itemize}
    %
    Using the induction hypothesis we deduce that there exist $\Measure_1$ and
    $\Measure_2$ such that $\wtpn{\Measure_i}{\Ctx_i, x : S_i}{P_i}$ and
    $\Measure_i \leq (n_i, 0)$ for $i=1,2$.
    %
    We conclude with one application of \refrule{mtb-par} by taking $\Measure
    \eqdef \Measure_1 + \Measure_2 + (0, \rankb{S_1}{S_2})$ and observing that
    $\Measure < (n_1, 0) + (n_2, 0) + (1, 0) = (n, 0)$.

    \proofcase{Case $P = \Cast\x Q$}
    %
    Then from \refrule{tb-cast} we deduce that there exist 
    $\CtxD$, $S$, $T$, $n$, $m$, $m_x$ such that:
    \begin{itemize}
    \item $\Ctx = \CtxD, x : S$
    \item $\wtp[m]{\CtxD, x : T}{Q}$
    \item $S \subt[m_x] T$
    \item $n = m_x + m$
    \end{itemize}
    %
    Using the induction hypothesis we deduce $\wtpn\MeasureN{\CtxD, x :
    T}{Q}$ for some $\MeasureN \leq (m, 0)$.
    %
    We conclude with one application of \refrule{mtb-cast} by taking $\Measure
    \eqdef \MeasureN + (m_x, 0)$ and observing that $\Measure \leq (m, 0) + (m_x, 0)
    = (n, 0)$.

    \proofcase{In all the other cases}
    %
    We conclude with one application of \refrule{mtb-thread} by taking $\Measure
    \eqdef (n, 0)$.
\end{proof}

The next lemma states that structural pre-congruence does not increase the measure
of a process.

\begin{lemma}
\label{lem:m_pcong_bin}
If\/ $\wtpn\MeasureM\Ctx P$ and $P \pcong Q$, then there exists $\MeasureN
\le \MeasureM$ such that $\wtpn\MeasureN\Ctx Q$.
\end{lemma}
\begin{proof}
By induction on the derivation of $P \pcong Q$ and by cases on the last rule
applied. We only consider the base cases.

\proofrule{sb-par-comm}
%
Then $P = \NewPar\x{P_1}{P_2} \pcong \NewPar\x{P_2}{P_1} = Q$.
%
From \refrule{mtb-par} we deduce that there exist $\Ctx_1$, $\Ctx_2$,
$S$, $T$, $\MeasureM_1$ and $\MeasureM_2$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \Ctx_2$
\item $\MeasureM = \MeasureM_1 + \MeasureM_2 + (0, \rankb{S}{T})$
\item $\wtpn{\MeasureM_1}{\Ctx_1, x : S}{P_1}$
\item $\wtpn{\MeasureM_2}{\Ctx_2, x : T}{P_2}$
\end{itemize}
We conclude with one application of \refrule{mtb-par} by taking $\MeasureN \eqdef
\MeasureM$.

\proofrule{sb-par-assoc}
%
Then $P = \NewPar\x{P_1}{\NewPar\y{Q_1}{Q_2}} \pcong
\NewPar\y{\NewPar\x{P_1}{Q_1}}{Q_2} = Q$.
%
From \refrule{mtb-par} we deduce that there exist $\Ctx_1$, $\CtxD_1$,
$\CtxD_2$, $\MeasureM_1$, $\MeasureN_1$, $\MeasureN_2$, $S_1$, $S_2$, $T_1$
and $T_2$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \CtxD_1, \CtxD_2$
\item $\MeasureM = \MeasureM_1 + (\MeasureN_1 + \MeasureN_2 + (0,
\rankb{T_1}{T_2})) + (0, \rankb{S_1}{S_2})$
\item $\wtpn{\MeasureM_1}{\Ctx_1, x : S_1}{P_1}$
\item $\wtpn{\MeasureN_1}{\CtxD_1, y : T_1, x : S_2}{Q_1}$
\item $\wtpn{\MeasureN_2}{\CtxD_2, y : T_2}{Q_2}$
\end{itemize}
We conclude with two applications of \refrule{mtb-par} by taking $\MeasureN
\eqdef \MeasureM$.

\proofrule{sb-cast-comm}
%
Then $P = \Cast\x \Cast\y P' \pcong \Cast\x \Cast\y P' = Q$.
%
We only consider the case $x \ne y$ or else there is nothing interesting to
prove. From \refrule{mtb-cast} we deduce that there exist $\Ctx'$,
$\MeasureM'$, $S_1$, $T_1$, $S_2$, $T_2$, $m_x$ and $m_y$ such that
\begin{itemize}
\item $S_1 \subt[m_x] S_2$
\item $T_1 \subt[m_y] T_2$
\item $\Ctx = \Ctx', x : S_1, y : T_1$
\item $\MeasureM = \MeasureM' + (m_x, 0) + (m_y, 0)$
\item $\wtpn{\MeasureM'}{\Ctx', x : S_2, y : T_2} P'$
\end{itemize}
We conclude with two applications of \refrule{mtb-cast} by taking $\MeasureN
\eqdef \MeasureM$.

\proofrule{sb-cast-new}
%
Then $P = \NewPar\x{\Cast\x P_1}{P_2} \pcong \NewPar\x{P_1}{P_2} = Q$.
%
From \refrule{mtb-par} we deduce that there exist $\Ctx_1$, $\Ctx_2$,
$\MeasureM_1$, $\MeasureM_2$, $S_1$ and $T$ such that:
\begin{itemize}
\item $\Ctx = \Ctx_1, \Ctx_2$
\item $\MeasureM = \MeasureM_1 + \MeasureM_2 + (0, \rankb{S_1}{T})$
\item $\wtpn{\MeasureM_1}{\Ctx_1, x : S_1}{\Cast\x P_1}$ and
$\wtpn{\MeasureM_2}{\Ctx_2, x : T}{P_2}$
\item $S_1 \compatible T$
\end{itemize}

From \refrule{mtb-cast} we deduce that there exist $\MeasureM_1'$, $S_2$ and $m_x$ such
that
\begin{itemize}
\item $S_1 \subt[m_x] S_2$
\item $\MeasureM_1 = \MeasureM_1' + (m_x , 0)$
\item $\wtpn{\MeasureM_1'}{\Ctx_1, x : S_2}{P_1}$
\end{itemize}

From $S_1 \compatible T$ and $S_1 \subt[m_x] S_2$ and \Cref{def:compatibility} we
deduce $S_2 \compatible T$.
%
We conclude with one application of \refrule{mtb-par} taking $\MeasureN \eqdef
\MeasureM_1' + \MeasureM_2 + (0, \rankb{S_2}{T}) < \MeasureM$.

\proofrule{sb-cast-swap}
%
Then $P = \NewPar\x{\Cast\y P_1}{P_2} \pcong \Cast\y{\NewPar\x{P_1}{P_2}} = Q$
and $x \ne y$.
%
From \refrule{mtb-par} we deduce that there exist $\Ctx_1$, $\MeasureM_1$,
$\MeasureM_2$, $S_1$, $S_2$ and $T_1$ such that:
\begin{itemize}
\item $\Ctx = \Ctx_1, \Ctx_2, y : T_1$
\item $\MeasureM = \MeasureM_1 + \MeasureM_2 + (0, \rankb{S_1}{S_2})$
\item $\wtpn{\MeasureM_1}{\Ctx_1, x : S_1, y : T_1}{\Cast\y P_1}$ and
$\wtpn{\MeasureM_2}{\Ctx_2, x : S_2}{P_2}$
\item $S_1 \compatible S_2$
\end{itemize}

From \refrule{mtb-cast} we deduce that there exist $\MeasureM_1'$, $T_2$ and $m_y$ such
that
\begin{itemize}
\item $T_1 \subt[m_y] T_2$
\item $\MeasureM_1 = \MeasureM_1' + (m_y, 0)$
\item $\wtp{\Ctx_1, x : S_1, y : T_2}{P_1}$
\end{itemize}

We derive $\wtpn{\MeasureM_1' + \MeasureM_2 + (0, \rankb{S_1}{S_2})}{\Ctx_1,
\Ctx_2, y : T_2}{\NewPar\x{P_1}{P_2}}$ with one application of
\refrule{mtb-par} and we conclude with one application of \refrule{mtb-cast} by
taking $\MeasureN \eqdef \MeasureM$.

\proofrule{sb-call}
%
Then $P = \Call{A}{\seqof\x} \pcong Q$ where $\Definition{A}{\seqof\x} Q$.
%
From \refrule{mtb-thread} we deduce that $\wtp[n]\Ctx{\Call A {\seqof\x}}$
for some $n$ such that $\MeasureM = (n, 0)$.
%
Using \Cref{lem:subj_cong_bin} we deduce that $\wtp[m]\Ctx Q$ for some $m \leq n$.
%
Using \Cref{lem:measure_rank_bin} we deduce that $\wtpn\MeasureN\Ctx Q$ for some
$\MeasureN \le (m, 0)$.
%
We conclude by observing that $\MeasureN \le (m, 0) \leq (n, 0) = \MeasureM$.
\end{proof}