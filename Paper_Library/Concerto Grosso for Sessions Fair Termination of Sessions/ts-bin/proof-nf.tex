\beginbass
%
In this section we introduce some normal forms that are instrumental to the
soundness proof of the type system. In particular, they allow us to prove
a \emph{quasi} deadlock freedom result which states that a well types process
can be rearranged in such a way that one of the reduction rule is ready to be 
applied. Deadlock freedom is achieved by considering the process in such
shape and the fact that the session under analysis is \emph{compatible}.

To this aim, it is useful to also introduce
\emph{process contexts} as a convenient way of referring to sub-processes. A
process context $\PCtxC$ is essentially a process with a \emph{hole} denoted by
$\Hole$:
\[
	\textbf{Process context}
	\quad
	\PCtxC, \PCtxD ~~::=~~ \Hole \mid \NewPar\x\PCtxC{P} \mid \NewPar\x{P}\PCtxC \mid \Cast\x\PCtxC
\]

As usual, we write $\PCtxC[P]$ for the process obtained by replacing the hole in $\PCtxC$ with $P$. 
Note that this operation may capture channel names that occur free in $P$ and that are bound by $\PCtxC$.

%%%%%%%%%%%%%%%%%%%
%%% DEFINITIONS %%%
%%%%%%%%%%%%%%%%%%%

\begin{definition}[Choice Normal Form]
	\label{def:cnf_bin}
	We say that $P_1 \pchoice P_2$ is an \emph{unguarded choice} of $P$ if there exists 
	$\PCtxC$ such that $P \pcong \PCtxC[P_1 \pchoice P_2]$. 
	We say that $P$ is in \emph{choice normal form} if it has no unguarded choices.
\end{definition}

We introduce a normal form that makes it easier to locate the components 
of a process that may interact with each other. 
Intuitively, a process is in \emph{thread normal form} if it consists of 
an initial prefix of casts followed by a parallel composition of threads, 
where a thread is either $\Done$ or a process waiting to perform an input/output 
action on some channel $x$. In this latter case, we say that the thread is an $x$-thread. 
Note that a process invocation $\Call A {\seqof\x}$ is \emph{not} a thread. Formally:

\begin{definition}[Thread Normal Form]
	\label{def:tnf_bin}
	A process is in \emph{thread normal form} if it is generated by the grammar below:
	\[
		\begin{array}{@{}rcl@{}}
			\Pnf, \Qnf & ::= & \Cast\x\Pnf \mid \Ppar
			\\
			\Ppar, \Qpar & ::= & \NewPar\x\Ppar\Qpar \mid \Pth
			\\
			\Pth & ::= &
			\Done \mid
			\Close\x \mid \Wait\x{P} \mid 
			\x\Pol\set{\l_i : P_i}_{i \in I} \mid
			\POutput\x\y.P \mid \PInput\x{(\y)}.P
		\end{array}
	\] 
\end{definition}

At last, a process in proximity normal form is such that there exist at least two 
$x$-threads that are next to each other. Since each thread is waiting to perform 
an operation on the same session $x$, the two thread may potentially 
reduce if the operations are complementary ones.

\begin{definition}[Proximity Normal Form]
	\label{def:pnf}
	We say that $\Pnf$ is in \emph{proximity normal form} if $\Pnf =
	\PCtxC[\NewPar\x\Pth\Qth]$ for some $\PCtxC$, $x$, $\Pth$ and $\Qth$ where
	$\Pth$ and $\Qth$ are $x$-threads.
\end{definition}

%%%%%%%%%%%%%%
%%% PROOFS %%%
%%%%%%%%%%%%%%

We can reduce any well-typed process into a process that is in choice normal form. 
The fact that the original process is well typed guarantees that this reduction 
eventually terminates when all the unguarded choices have been resolved.

\begin{lemma}
	\label{lem:cnf2_bin}
	If $\wtp[n]\Ctx{P}$ and $\wtpi\Ctx{P}$, then there exists $Q$ in choice
	normal form such that $P \wred Q$ and $\wtp[m]\Ctx{Q}$ for some $m \le n$.
\end{lemma}
\begin{proof}
By induction on $\wtpi\Ctx{P}$ and by cases on the last rule applied.

\proofcase{Case $P$ is already in choice normal form} 
We conclude taking $Q \eqdef P$ and $m \eqdef n$.

\proofrule{tb-call}
Then $P = \pinvk{A}{\seqof{u}}$ and $\Definition{A}{\seqof{x}}{R}$.
We deduce $\Ctx = \seqof{u : S}$, $\tass{A}{\seqof{S}}{n'}$ and $\wtpi\Ctx{R\subst{\seqof u}{\seqof x}}$. Moreover, it must be the case that
$\wtp[n']\Ctx{R\subst{\seqof u}{\seqof x}}$ and $n' \leq n$ since \refrule{tb-call} is used in the coinductive judgment as well.
Using the induction hypothesis we deduce that there exist $Q$ in choice normal form and $m \le n'$ such that $R\subst{\seqof u}{\seqof x} \wred Q$ 
and $\wtp[m]\Ctx{Q}$.
We conclude by observing that $P \wred Q$ using \refrule{rb-struct} and that $m \leq n' \leq n$.

\proofrule{cob-choice}
Then $P = P_1 \pchoice P_2$.
We deduce $\wtpi\Ctx{P_k}$ with $k \in \set{1,2}$.
Moreover, it must be the case that $\wtp[n]\Ctx{P_k}$ since \refrule{tb-choice} is used in the coinductive judgment.
Using the induction hypothesis we deduce that there exist $Q$ in choice normal form and $m \leq n$ such that $P_k \wred Q$ and $\wtp[m]\Ctx{Q}$.
We conclude by observing that $P \red P_k$ by \refrule{rb-choice}.

\proofrule{tb-choice}
Analogous to the previous case but we consider the premise in which the rank is the same of the conclusion to keep sure that it does not increase.

\proofrule{tb-par}
Then $P = \pres{x}{P_1 \parop P_2}$. 
We deduce that there exist $\Ctx_1, \Ctx_2, S_1, S_2$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \Ctx_2$
\item $\wtpi{\Ctx_1, x : S_1}{P_1}$
\item $\wtpi{\Ctx_2, x : S_2}{P_2}$
\item $S_1 \compatible S_2$
\end{itemize}
Furthermore, it must be the case that there exist $n_1$ and $n_2$ such that
$\wtp[n_i]{\Ctx_i, x : S_i}{P_i}$ for $i=1,2$ 
and $n = 1 + n_1 + n_2$ since \refrule{tb-par} is used in the coinductive judgment as well.
Using the induction hypothesis we deduce that there exist $Q_i$ in choice normal form and $m_i \leq n_i$ such that 
$P_i \wred Q_i$ and $\wtp[m_i]{\Ctx_i, x : S_i}{Q_i}$ for $i=1,2$.
We conclude by taking $m \eqdef 1 + m_1 + m_2$ and $Q \eqdef \pres{s}{Q_1 \parop Q_2}$ 
with one application of \refrule{tb-par}, observing that 
$m = 1 + + m_1 + m_2 \leq 1 + n_1 + n_2 = n$ and that $P \wred Q$ by \refrule{rb-par}.

\proofrule{tb-cast}
Then $P = \pcast{x} P'$.
Analogous to the previous case, just simpler.
\end{proof}

\begin{lemma}
	\label{lem:cnf1_bin}
	If $\wtp[n]\Ctx{P}$, then there exists $Q$ in choice normal form such that $P \wred Q$ and $\wtp[m]\Ctx{Q}$ for some $m \le n$.
\end{lemma}
\begin{proof}
	\brk
	Consequence of \Cref{lem:cnf2_bin} noting that $\wtp[n]\Ctx{P}$ implies $\wtpi\Ctx{P}$.
\end{proof}

\begin{lemma}
	\label{lem:cnf_exists_bin}
	If\/ $\wtpn\MeasureM\Ctx{P}$, then there exist $Q$ in choice normal form and 
	$\MeasureN \leq \MeasureM$ such that $P \wred Q$ and $\wtpn\MeasureN\Ctx{Q}$.
\end{lemma}
\begin{proof}
By induction on $\wtpn\Measure\Ctx{P}$ and by cases on the last rule applied.

\proofrule{mtb-thread}
Then $P$ is a thread. We deduce that
\begin{itemize}
\item $\Measure = (n , 0)$ for some $n$
\item $\wtp[n]\Ctx{P}$
\end{itemize}
From \Cref{lem:cnf1_bin} we deduce that there exist $Q$ and $m \le n$ such that $P \wred Q$ and $\wtp[m]\Ctx{Q}$. 
From \Cref{lem:measure_rank_bin} we deduce $\wtpn\MeasureN\Ctx{Q}$ for some $\MeasureN \le (m , 0)$. 
We conclude observing that $\MeasureN \le (m , 0) \le (n , 0) = \Measure$.

\proofrule{mtb-cast}
Then $P = \pcast{x}{P'}$. We deduce that
\begin{itemize}
\item $\Ctx = \CtxD, x : S$
\item $S \subt[n] T$
\item $\Measure = \Measure' + (n,0)$
\item $\wtpn{\Measure'}{\Ctx', x : T}{P'}$
\end{itemize}
Using the induction hypothesis we deduce that there exist $Q'$ and $\MeasureN' \le \Measure'$ such that $P' \wred Q'$ 
and $\wtpn{\MeasureN'}{\Ctx', x : T}{Q'}$. We conclude with an application of \refrule{mtb-cast} taking 
$Q \eqdef \pcast{x}{Q'}$, $\MeasureN \eqdef \MeasureN' + (n,0)$ and observing that $P \wred Q$ using \refrule{rb-cast}. 

\proofrule{mtb-par}
Then $P = \pres{s}{P_1 \parop P_2}$. 
We deduce that there exist $\Ctx_1, \Ctx_2, S_1, S_2, \Measure_1, \Measure_2$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \Ctx_2$
\item $\wtpn{\Measure_1}{\Ctx_1, x : S_1}{P_1}$
\item $\wtpn{\Measure_2}{\Ctx_2, x : S_2}{P_2}$
\item $\Measure = \Measure_1 + \Measure_2 + (0, \rankb{S_1}{S_2})$
\item $S_1 \compatible S_2$
\end{itemize}
Using the induction hypothesis we deduce that there exist 
$Q_i$ in choice normal form and $\MeasureN_i \leq \Measure_i$ such that $P_i \wred Q_i$ and 
$\wtpn{\MeasureN_i}{\Ctx_i, x : S_i}{Q_i}$ for $i=1,2$.
We conclude by taking $\MeasureN \eqdef \MeasureN_i + \MeasureN_2 + (0, \rankb{S_1}{S_2})$ and 
$Q \eqdef \pres{s}{Q_1 \parop Q_2}$ with one application of \refrule{mtb-par}, 
observing that 
\[
\MeasureN = \MeasureN_1 + \MeasureN_2 + (0, \rankb{S_1}{S_2}) \leq 
						\Measure_1 + \Measure_2 + (0, \rankb{S_1}{S_2}) = \Measure
\]
and that $P \wred Q$ by \refrule{rb-par}.
\end{proof}

It is easy to rewrite any \emph{well-typed} process that is in choice normal 
form into thread normal form using structural pre-congruence. 
The hypothesis that the process is well typed, at least according to the 
inductive interpretation of the typing rules with the corule \refrule{cob-tag},
is necessary to guarantee that a process invocation may eventually be expanded 
to a term other than another process invocation. 
For example, the process $A$ defined by $\Definition{A}{}{A}$ has 
no thread normal form and is ill typed. By combining this result with 
\Cref{lem:subj_cong_bin} we can deduce that the obtained thread normal form is also well typed.

\begin{lemma}
\label{lem:tnf_exists_bin}
	If\/ $\wtpi\Ctx P$ and $P$ is in choice normal form, then there exists
	$\Pnf$ such that $P \pcong \Pnf$. 
\end{lemma}
\begin{proof}
	By induction on $\wtpi\Ctx P$ and by cases on the last rule applied.

	\proofcase{Cases \refrule{tb-choice} and \refrule{co-choice}} 
	%
	These cases are impossible from the hypothesis that $P$ is in choice normal form.

	\proofcase{Cases \refrule{tb-done}, \refrule{tb-wait}, \refrule{tb-close}, 
	\refrule{tb-channel-in}, \refrule{tb-channel-out}, \refrule{tb-label}, \refrule{co-label}}
	%
	Then $P$ is a thread and is already in thread normal form and we conclude by
	reflexivity of $\pcong$.

	\proofrule{tb-call}
	%
	Then there exist $A$, $Q$, $\seqof\x$ and $\seqof\S$ such that
	\begin{itemize}
	\item $P = \Call{A}{\seqof\x}$
	\item $\Definition{A}{\seqof\x}Q$
	\item $\Ctx = \seqof{x : S}$
	\item $\wtpi{\seqof{x : S}}{Q}$
	\end{itemize}

	Using the induction hypothesis on $\wtpi{\seqof{x : S}}{Q}$ 
	we deduce that there exists $\Pnf$ such that $Q \pcong \Pnf$.
	%
	We conclude $P \pcong \Pnf$ using \refrule{sb-call} and the transitivity of $\pcong$.

	\proofrule{tb-par}
	%
	Then there exist $x$, $P_1$, $P_2$, $\Ctx_1$, $\Ctx_2$, $S_1$ and $S_2$ such that
	\begin{itemize}
	\item $P = \NewPar\x{P_1}{P_2}$
	\item $\Ctx = \Ctx_1, \Ctx_2$
	\item $\wtpi{\Ctx_i, x : S_i}{P_i}$ for $i=1,2$
	\end{itemize}

	Using the induction hypothesis on $\wtpi{\Ctx_i, x : S_i}{P_i}$ we deduce 
	that there exists $\Pnf_i$ such that $P_i \pcong \Pnf_i$ for $i=1,2$.
	%
	By definition of thread normal form, it must be the case that 
	$\Pnf_i = \Cast{\seqof{x_i}} \Ppar_i$ for some $\seqof{x_i}$ and $\Ppar_i$.
	Let $\seqof{y_i}$ be the same sequence as $\seqof{x_i}$ except that occurrences of $x$ have been removed.
	%
	We conclude by taking 
	$\Pnf \eqdef \Cast{\seqof{y_1}\seqof{y_2}}\NewPar\x{\Ppar_1}{\Ppar_2}$ and observing that
	\[
		\begin{array}{rcll}
			P & = & \NewPar\x{P_1}{P_2} & \text{by definition of $P$}
			\\
			& \pcong & \NewPar\x{\Pnf_1}{\Pnf_2} & \text{using the induction hypothesis}
			\\
			& = & \NewPar\x{\Cast{\seqof{x_1}}\Ppar_1}{\Cast{\seqof{x_2}}\Ppar_2}
			& \text{by definition of thread normal form}
			\\
			& \pcong & \Cast{\seqof{y_1}\seqof{y_2}}\NewPar\x{\Ppar_1}{\Ppar_2}
			& \text{by \refrule{sb-cast-new},} \\
			& & & \text{\refrule{sb-cast-swap} and \refrule{sb-par-comm}}
			\\
			& = & \Pnf & \text{by definition of $\Pnf$}
		\end{array}
	\]

	\proofrule{tb-cast}
	%
	Then there exist $x$, $Q$, $\Ctx'$, $S$ and $T$ such that
	\begin{itemize}
	\item $P = \Cast\x Q$
	\item $\Ctx = \Ctx', x : S$
	\item $\wtpi{\Ctx', x : T}{Q}$
	\item $S \subt T$
	\end{itemize}

	Using the induction hypothesis on $\wtpi{\Ctx', x : T}{Q}$ we 
	deduce that there exists $\Qnf$ such that $Q \pcong \Qnf$.
	%
	We conclude by taking $\Pnf \eqdef \Cast\x\Qnf$ using the fact that $\pcong$ is a pre-congruence.
\end{proof}

In order to show that every well-typed, closed process in thread normal form can 
also be rewritten in proximity normal form we prove \Cref{lem:proximity_bin}, 
which pushes a restriction $(x)$ next to a process in which $x$ occurs free, 
which might as well be an $x$-thread.

\begin{lemma}[Proximity]
  \label{lem:proximity_bin}
  If $x\in\fn{P} \setminus \bn\PCtxC$, then $\NewPar\x{\PCtxC[P]}{Q}
  \pcong \PCtxD[\NewPar\x{P}{Q}]$ for some $\PCtxD$.
\end{lemma}
\begin{proof}
  By induction on the structure of $\PCtxC$ and by cases on its shape.

  \proofcase{Case $\PCtxC = \Hole$}
  %
  We conclude by taking $\PCtxD \eqdef \Hole$ using the reflexivity
  of $\pcong$.

  \proofcase{Case $\PCtxC = \NewPar\y{\PCtxC'}{R}$}
  %
  From the hypothesis $x \in \fn{P} \setminus \bn\PCtxC$ 
  we deduce $x \ne y$ and $x \in \fn{P} \setminus \bn{\PCtxC'}$.
  %
  Using the induction hypothesis we deduce that there exists $\PCtxD'$ 
  such that $\NewPar\x{\PCtxC'[P]}{Q} \pcong \PCtxD'[\NewPar\x{P}{Q}]$.
  %
  Take $\PCtxD \eqdef \NewPar\y{\PCtxD'}{R}$. We conclude
  \[
    \begin{array}{rcll}
      \NewPar\x{\PCtxC[P]}{Q}
      & = & \NewPar\x{\NewPar\y{\PCtxC'[P]}{R}}{Q}
      & \text{by definition of $\PCtxC$}
      \\
      & \pcong & \NewPar\x{Q}{\NewPar\y{\PCtxC'[P]}{R}}
      & \text{by \refrule{sb-par-comm}}
      \\
      & \pcong & \NewPar\y{\NewPar\x{Q}{\PCtxC'[P]}}{R}
      & \text{by \refrule{sb-par-assoc}} \\
      & & & \text{and $x \in \fn{\PCtxC'[P]}$}
      \\
      & \pcong & \NewPar\y{\NewPar\x{\PCtxC'[P]}{Q}}{R}
      & \text{by \refrule{sb-par-comm}}
      \\
      & \pcong & \NewPar\y{\PCtxD'[\NewPar\x{P}{Q}]}{R}
      & \text{by induction hypothesis}
      \\
      & = & \PCtxD[\NewPar\x{P}{Q}]
      & \text{by definition of $\PCtxD$}
    \end{array}
  \]
  where, in using \refrule{sb-par-assoc}, we note that
  $x \in \fn{\PCtxC'[P]}$ since $x \in \fn{P} \setminus \bn\PCtxC$.

  \proofcase{Case $\PCtxC = \NewPar\y{R}{\PCtxC'}$}
  %
  Symmetric of the previous case.

  \proofcase{Case $\PCtxC = \Cast\y\PCtxC'$ and $x \ne y$}
  %
  Using the induction hypothesis we deduce that there exists $\PCtxD'$ such that
  $\NewPar\x{\PCtxC'[P]}{Q} \pcong \PCtxD'[\NewPar\x{P}{Q}]$.
  %
  Take $\PCtxD \eqdef \Cast\y\PCtxD'$. We conclude
  \[
    \begin{array}{rcll}
      \NewPar\x{\PCtxC[P]}{Q}
      & = & \NewPar\x{\Cast\y\PCtxC'[P]}{Q}
      & \text{by definition of $\PCtxC$}
      \\
      & \pcong & \Cast\y\NewPar\x{\PCtxC'[P]}{Q}
      & \text{by \refrule{sb-cast-swap} and $x \ne y$}
      \\
      & \pcong & \Cast\y\PCtxD'[\NewPar\x{P}{Q}]
      & \text{using the induction hypothesis}
      \\
      & = & \PCtxD[\NewPar\x{P}{Q}]
      & \text{by definition of $\PCtxD$}
    \end{array}
  \]

  \proofcase{Case $\PCtxC = \Cast\x\PCtxC'$}
  %
  Using the induction hypothesis we deduce that there exists $\PCtxD$ such that
  $\NewPar\x{\PCtxC'[P]}{Q} \pcong \PCtxD[\NewPar\x{P}{Q}]$.
  %
  We conclude
  \[
    \begin{array}[b]{rcll}
      \NewPar\x{\PCtxC[P]}{Q}
      & = & \NewPar\x{\Cast\x\PCtxC'[P]}{Q}
      & \text{by definition of $\PCtxC$}
      \\
      & \pcong & \NewPar\x{\PCtxC'[P]}{Q}
      & \text{by \refrule{sb-cast-new}}
      \\
      & \pcong & \PCtxD[\NewPar\x{P}{Q}]
      & \text{using the induction hypothesis}
    \end{array}
    \qedhere
  \]
\end{proof}

We can now prove the fact that every well-typed, closed process in thread normal form can 
be rewritten using structural pre-congruence either to $\Done$ or to a process in proximity normal form. 
Note that this property the one that, combined with the \emph{compatibility} of the involved session,
guarantees deadlock freedom.

\begin{lemma}[Quasi Deadlock Freedom]
	\label{lem:dl_freedom_bin}
	If\/ $\wtpn\Measure\EmptyCtx\Pnf$, then $\Pnf = \Done$ or $\Pnf
	\pcong \Qnf$ for some $\Qnf$ in proximity normal form.
\end{lemma}
\begin{proof}
	A simple induction on the derivation of $\wtpn\MeasureM\EmptyCtx\Pnf$
	allows us to deduce that $\Pnf$ consists of $k$ sessions and $k+1$ threads.
  	%
	If $k = 0$, then we conclude $\Pnf = \Done$.
  	%
  	If $k > 0$, then each of the $k+1$ threads is an $x_i$-thread for some
	$x_i$. Since there are $k+1$ threads but only $k$ distinct sessions, it must
	be the case that $x_i = x_j$ for some $1 \leq i < j \leq k+1$. In other
	words, there exist $\PCtxC$, $\PCtxC_1$, $\PCtxC_2$, $\Pth_1$ and $\Pth_2$ such
	that $\Pth_1$ and $\Pth_2$ are $x$-threads and $\Pnf =
	\PCtxC[\NewPar\x{\PCtxC_1[\Pth_1]}{\PCtxC_2[\Pth_2]}]$.
	%
	We conclude
	\[
		\begin{array}{rcll}
			\Pnf & = & \PCtxC[\NewPar\x{\PCtxC_1[\Pth_1]}{\PCtxC_2[\Pth_2]}]
			& \text{by definition of $\Pnf$}
			\\
			& \pcong & \PCtxC[\PCtxD_1[\NewPar\x{\Pth_1}{\PCtxC_2[\Pth_2]}]]
			& \text{for some $\PCtxD_1$ by \Cref{lem:proximity_bin}}
			\\
			& \pcong & \PCtxC[\PCtxD_1[\NewPar\x{\PCtxC_2[\Pth_2]}{\Pth_1}]]
			& \text{by \refrule{s-par-comm}}
			\\
			& \pcong & \PCtxC[\PCtxD_1[\PCtxD_2[\NewPar\x{\Pth_2}{\Pth_1}]]]
			& \text{for some $\PCtxD_2$ by \Cref{lem:proximity_bin}}
			\\
			& \eqdef & \Qnf
		\end{array}
	\]
	where $x = x_i = x_j$. The fact that $\Qnf$ is in thread normal form follows
	 from the observation that $\Pnf$ does not have unguarded casts (it is a closed process in thread normal form) 
	 so the pre-congruence rules applied here and in \Cref{lem:proximity_bin} do not move casts around. 
	 We conclude that $\Qnf$ is in proximity normal form by its shape.
\end{proof}
