\beginbass
%
We show the proof of a standard subject reduction theorem (see \Cref{lem:subj_red_multi}). For this sake,
we need an additional result, that we dub subject congruence,
stating that well-typedness is preserved by the structural precongruence
relation for processes in \Cref{fig:pcong_multi} (\Cref{lem:subj_cong_multi}).
Notably, \Cref{lem:subj_cong_multi} tells that the rank does not incrase.
Such result is not provable in \Cref{lem:subj_red_multi} as the non deterministic choice
can reduce to a branch that increases the rank.

\begin{lemma}
\label{lem:substitution_multi}
	If $\wtp[n]{\Ctx, x : S}{P}$ and $\Ctx, u : S$ is defined, then $\wtp[n]{\Ctx, u : S}{P \subst{u}{x}}$.
	A typing context is \emph{defined} if the endpoints occurring in it all have different session names.
\end{lemma}
\begin{proof}
By bounded coinduction (see \Cref{prop:bcp}).
\end{proof}

\begin{lemma}[Subject Congruence]
\label{lem:subj_cong_multi}
	If\/ $\wtp[n] \Ctx {P}$ and $P \pcong Q$, then $\wtp[m] \Ctx {Q}$ for some $m \leq n$.
\end{lemma}
\begin{proof}
By induction on the derivation of $P \pcong Q$ and by cases on the last rule applied.

\proofrule{sm-par-comm} 
%
Then $P = \pres{s}{\procs{P} \ppar P' \ppar Q' \ppar \procs{Q}} \pcong \pres{s}{\procs{P} \ppar Q' \ppar P' \ppar \procs{Q}} = Q$.
%
From rule \refrule{tm-par} we deduce that there exist $\Ctx_i, \role_i, S_i, n_i$ for $i = 1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{P_i}$ for $i = 1,\dots,k$
\item $\wtp[n_{k+1}]{\Ctx_{k+1}, \ep{s}{\role_{k+1}} : S_{k+1}}{P'}$
\item $\wtp[n_{k+2}]{\Ctx_{k+2}, \ep{s}{\role_{k+2}} : S_{k+2}}{Q'}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{Q_i}$ for $i = k+3,\dots,h$
\end{itemize}

We conclude $\wtp[m]\Ctx{Q}$ with one application of \refrule{tm-par} by taking $m \eqdef n$.

\proofrule{sm-par-assoc}
%
Then $P = \pres{s}{\procs{P} \ppar \pres{t}{R \ppar \procs{Q}}} \pcong \pres{t}{\pres{s}{\procs{P} \ppar R} \ppar \procs{Q}} = Q$ and $s \in \fn{R}$.
%
From rule \refrule{tm-par} we deduce that there exist $\Ctx_i, \role_i, S_i, n_i$ for $i = 1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{P_i}$ for $i = 1,\dots,h - 1$
\item $\wtp[n_h]{\Ctx_h, \ep{s}{\role_h} : S_h}{\pres{t}{R \ppar \procs{Q}}}$
\end{itemize}
From rule \refrule{tm-par} and the hypothesis that $s \in \fn{R}$ we deduce that there exist $\CtxD_i, \roleq_i, T_i, m_i$ for $i = 1,\dots,k$ such that
\begin{itemize}
\item $\Ctx_h = \CtxD_1,\dots,\CtxD_k$
\item $n_h = 1 + \sum_1^k m_i$
\item $\prod_1^k \Map{\roleq_i}{T_i} \ft$
\item $\wtp[m_1]{\CtxD_1, \ep{s}{\role_h} : S_h, \ep{t}{\roleq_1} : T_1}{R}$
\item $\wtp[m_{i+1}]{\CtxD_{i+1}, \ep{t}{\roleq_{i+1}} : T_{i+1}}{Q_i}$ for $i = 1,\dots,k-1$
\end{itemize}
Using \refrule{tm-par} we deduce 
$\wtp[1 + \sum_{i=1}^{h-1}{n_i} + m_1]{\Ctx_1,\dots,\Ctx_{h-1},\CtxD_1, \ep{t}{\roleq_1} : T_1}{\pres{s}{\procs{P} \ppar R}}$.
We conclude $\wtp[m]{\Ctx}{\pres{t}{\pres{s}{\procs{P} \ppar R} \ppar \procs{Q}}}$ with another application of \refrule{tm-par} by taking $m \eqdef n$.

\proofrule{sm-cast-comm} 
%
Then $P = \pcast{u}{\pcast{v}{R}} \pcong \pcast{v}{\pcast{u}{R}} = Q$. We can assume $u \ne v$ or else $P = Q$.
%
From rule \refrule{tm-cast} we deduce that there exist $\Ctx_1, S, T, n_1, n_u$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, u : S$
\item $S \subt[n_u] T$
\item $n = n_u + n_1$
\item $\wtp[n_1]{\Ctx_1, u : T}{\pcast{v}{R}}$
\end{itemize} 
From rule \refrule{tm-cast} we deduce that there exist $\Ctx_2, S', T', n_2, n_v$ such that
\begin{itemize}
\item $\Ctx_1 = \Ctx_2, v : S'$
\item $S' \subt[n_v] T'$
\item $n_1 = n_v + n_2$
\item $\wtp[n_2]{\Ctx_2, u : T, v : T'}{R}$
\end{itemize}
We derive $\wtp[n_u + n_2]{\Ctx_2, u : S, v : T'}{\pcast{u}{R}}$ with one application of \refrule{tm-cast} 
and we conclude with another application of \refrule{tm-cast} by taking $m \eqdef n$.

\proofrule{sm-cast-new}
%
Then $P = \pres{s}{\pcast{\ep{s}{\role}}{R} \ppar \procs{P}} \pcong \pres{s}{R \ppar \procs{P}} = Q$.
%
From rule \refrule{tm-par} we deduce that there exist $\CtxD, n'$ and $\Ctx_i, \roleq_i, n_i$ for $i = 1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \CtxD, \Ctx_1, \dots, \Ctx_h$ for $i = 1,\dots,h$
\item $n = 1 + n' + \sum_{i=1}^h n_i$
\item $\Map{\role}{S} \ppar \prod_{i = 1}^h \Map{\roleq_i}{S_i} \ft$
\item $\wtp[n']{\CtxD, \ep{s}{\role} : S}{\pcast{\ep{s}{\role}}{R}}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\roleq_i} : S_i}{P_i}$ for $i = 1,\dots,h$
\end{itemize} 
From rule \refrule{tm-cast} we deduce that there exist $T, m', m_s$ such that
\begin{itemize}
\item $S \subt[m_s] T$
\item $n' = m_s + m'$
\item $\wtp[m']{\CtxD, \ep{s}{\role} : T}{R}$
\end{itemize}
From $\Map{\role}{S} \ppar \prod_{i = 1}^h \Map{\roleq_i}{S_i} \ft$, $S \subt[m_s] T$ and \cref{def:ssubt} we deduce 
$\Map{\role}{T} \ppar \prod_{i = 1}^h \Map{\roleq_i}{S_i} \ft$.
We conclude with an application of \refrule{tm-par} by taking $m \eqdef 1 + m' + \sum_{i=1}^h n_i \le n$.

\proofrule{sm-cast-swap}
%
Then $P = \pres{s}{\pcast{\ep{t}{\role}}{R} \ppar \procs{P}} \pcong \pcast{\ep{t}{\role}}{\pres{s}{R \ppar \procs{P}}} = Q$ and $t \ne s$.
%
From rule \refrule{tm-par} we deduce that there exist $\Ctx_i, \roleq_i, n_i$ for $i = 1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \dots, \Ctx_h$ for $i = 1,\dots,h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i = 1}^h \Map{\roleq_i}{S_i} \ft$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\roleq_1} : S_1}{\pcast{\ep{t}{\role}}{R}}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\roleq_i} : S_i}{P_i}$ for $i = 2,\dots,h$
\end{itemize} 
From rule \refrule{tm-cast} we deduce that there exist $\CtxD, T, n', m_t$ such that
\begin{itemize}
\item $\Ctx_1 = \CtxD, \ep{t}{\role} : S$
\item $S \subt[m_t] T$
\item $n_1 = m_t + n'$
\item $\wtp[n']{\CtxD, \ep{t}{\role} : T, \ep{s}{\roleq_1} : S_1}{R}$
\end{itemize}
We derive $\wtp[1 + n' + \sum_{i=2}^h n_i]{\CtxD, \ep{t}{\role} : T,\Ctx_2,\dots,\Ctx_h}{\pres{s}{R \ppar \procs{P}}}$ 
with an application of \refrule{tm-par}. We conclude with an application of \refrule{tm-cast} by taking $m \eqdef n$.

\proofrule{sm-call} 
%
Then $P = \pinvk{A}{\seqof u} \pcong R\subst{\seqof u}{\seqof x} = Q$ and
$\Definition{A}{\seqof x}{R}$.
%
From \refrule{tm-call} we conclude that there exist $\seqof S$ and $m$ such that
$\tass{A}{\seqof{S}}{m}$ and $\Ctx = \seqof{u : S}$ and $\wtp[m]{\seqof{u :
S}}{Q}$ and $m \leq n$.
\end{proof}

\begin{lemma}[Subject Reduction]
	\label{lem:subj_red_multi}
	If\/ $\wtp[n] \Ctx {P}$ and $P \red Q$, then $\wtp[m] \Ctx {Q}$ for some $m$.
\end{lemma}
\begin{proof}
By induction on the derivation of $P \red Q$ and by cases on the last rule applied.

\proofrule{rm-choice}
%
Then $P = P_1 \pchoice P_2 \red P_k = Q$ and $k \in \set{1,2}$.
%
From \refrule{tm-choice} we deduce that $\wtp[m]{\Ctx}{Q}$ for some $m$.

\proofrule{rm-signal}
%
Then $ P = \pres{s}{\pwait{\ep{s}{\role}}{Q} \parop \pclose{\ep{s}{\roleq_1}} \parop \cdots \parop \pclose{\ep{s}{\roleq_h}}} \red Q$.
%
From \refrule{tm-par}, \refrule{tm-wait} and \refrule{tm-close} we deduce that there exist $m$ and $n_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $n = 1 + m + \sum_{i=1}^h n_i$
\item $\wtp[m]{\Ctx, \ep{s}{\role} : \End[\In]}{\pwait{\ep{s}{\role}}{Q}}$
\item $\wtp[m]{\Ctx}{Q}$
\item $\wtp[n_i]{\ep{s}{\roleq_i} : \End[\Out]}{\pclose{\ep{s}{\roleq_i}}}$ for
$i=1,\dots,h$
\end{itemize}
There is nothing left to prove.

\proofrule{rm-channel}
%
Then $P = \pres{s}{\poch{\ep{s}{\rolep}}{\roleq}{v}{P'} \parop
\pich{\ep{s}{\roleq}}{\rolep}{x}{Q'} \parop \procs{R}} \red \pres{s}{P' \parop
Q'\subst{v}{x} \parop \procs{R}} = Q$.
%
From \refrule{tm-par} we deduce that there exist $\Ctx_i, S_i, \role_i, n_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\role = \role_1$ and $\roleq = \role_2$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : S_1}{\poch{\ep{s}{\rolep}}{\roleq}{v}{P'}}$
\item $\wtp[n_2]{\Ctx_2, \ep{s}{\roleq} : S_2}{\pich{\ep{s}{\roleq}}{\rolep}{x}{Q'}}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{R_i}$ for $i = 3,\dots,h$
\end{itemize}
From \refrule{tm-channel-out} and \refrule{tm-channel-in} we deduce that there exist $S_v, T_1, T_2, \CtxD_1$ such that
\begin{itemize}
\item $S_1 = \roleq\Out{S_v}.T_1$
\item $\Ctx_1 = \CtxD_1, v : S_v$
\item $\wtp[n_1]{\CtxD_1, \ep{s}{\rolep} : T_1}{P'}$
\item $S_2 = \rolep\In{S_v}.T_2$
\item $\wtp[n_2]{\Ctx_2, \ep{s}{\roleq} : T_2, x : S_v}{Q'}$
\end{itemize} 
Using \cref{lem:substitution_multi} we deduce $\wtp[n_2]{\Ctx_2, \ep{s}{\roleq} : T_2,
v : S_v}{Q'\subst{v}{x}}$. Using \cref{def:coherence} we deduce $\Map{\rolep}{T_1}
\parop \Map{\roleq}{T_2} \parop \prod_{i=3}^h \Map{\role_i}{S_i} \ft$. We conclude with
one application of \refrule{tm-par} taking $m \eqdef n$.

\proofrule{rm-pick}
%
Then $P = \pres{s}{\pobranch[i\in I]{\ep{s}{\role}}{\roleq}{\Tag_i}{\PP_i} \parop \procs{Q}} \red 
\pres{s}{\pobranch{\ep{s}{\role}}{\roleq}{\Tag_k}{\PP_k}\parop \procs{Q}} = Q$ and $k \in I$. %$|I| > 1$
%
From \refrule{tm-par} we deduce that there exist $\Ctx_i, \role_i, n_i, S_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1, \dots, \Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\role = \role_1$ and $\roleq = \role_i$ for some $i \in \set{2,\dots,h}$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : S_1}{\pobranch[i\in I]{\ep{s}{\role}}{\roleq}{\Tag_i}{\PP_i}}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{Q_i}$ for $i=2,\dots,h$
\end{itemize}
From \refrule{tm-tag} we deduce that there exist $T_i$ for all $i \in I$ such that
\begin{itemize}
\item $S_1 = \Tags\roleq\Out \Tag_i.T_i$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : T_i}{P_i}~{}^{(i\in I)}$
\end{itemize}
From the hypothesis that $k \in I$ we deduce that $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : T_k}{P_k}$ and from \refrule{tm-tag} we deduce 
$\wtp[n_1]{\Ctx_1, \ep{s}{\role} : \roleq\Out\Tag_k.T_k}{\pobranch{\ep{s}{\role}}{\roleq}{\Tag_k}{\PP_k}}$. 
From \cref{def:coherence} we deduce that $\roleq\Out\Tag_k.T_k \parop \prod_{i=2}^h \Map{\role_i}{S_i} \ft$. 
We conclude with an application of \refrule{tm-par} taking $m \eqdef n$.

\proofrule{rm-tag}
%
Then $P = \pres{s}{\pobranch{\ep{s}{\role}}{\roleq}{\Tag_k}{\PP'} \parop \pibranch[i\in I]{\ep{s}{\roleq}}{\role}{\Tag_i}{Q_i} \parop \procs{R}} 
        \red 
        \pres{s}{P' \parop Q_k \parop \procs{R}} = Q$ and $k \in I$.
%
From \refrule{tm-par} we deduce that there exist $\Ctx_i, S_i, \role_i, n_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\role = \role_1$ and $\roleq = \role_2$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : S_1}{\pobranch{\ep{s}{\role}}{\roleq}{\Tag_k}{\PP'}}$
\item $\wtp[n_2]{\Ctx_2, \ep{s}{\roleq} : S_2}{\pibranch[i\in I]{\ep{s}{\roleq}}{\role}{\Tag_i}{Q_i}}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{R_i}$ for $i = 3,\dots,h$
\end{itemize}
From \refrule{tm-tag} we deduce that there exist $S'_1$ and $T_i$ for every $i \in I$ such that
\begin{itemize}
\item $S_1 = \roleq\Out \Tag_k.S'_1$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role} : S'_1}{P'}$
\item $S_2 = \Tags\rolep\In \Tag_i.T_i$
\item $\wtp[n_2]{\Ctx_2, \ep{s}{\roleq} : T_i}{Q_i}~{}^{(i\in I)}$
\end{itemize}
From \cref{def:coherence} we deduce that $\Map{\role}{S'_1} \parop \Map{\roleq}{T_k} \parop \prod_{i=2}^h \Map{\role_i}{S_i} \ft$. 
We conclude with an application of \refrule{tm-par} by taking $m \eqdef n$.

\proofrule{rm-par}
%
Then $P = \pres{s}{P' \parop \procs{R}} \red \pres{s}{Q' \parop \procs{R}} = Q$ and $P' \red Q'$.
%
From \refrule{tm-par} we deduce that there exist $\Ctx_i, \role_i, S_i, n_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $n = 1 + \sum_{i=1}^h n_i$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role_1} : S_1}{P'}$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{R_i}$ for $i = 2,\dots, h$
\end{itemize}
Using the induction hypothesis on $\wtp[n_1]{\Ctx_1, \ep{s}{\role_1} : S_1}{P'}$ and $P' \red Q'$
we deduce $\wtp[n'_1]{\Ctx_1, \ep{s}{\role_1} : S_1}{Q'}$ for some $n'_1$. We conclude with an application 
of \refrule{tm-par} taking $m \eqdef 1 + n'_1 + \sum_{i=2}^h n_i$.

\proofrule{rm-cast}
%
Then $P = \pcast{u}{P'} \red \pcast{u}{Q' } = Q$ and $P' \red Q'$.
%
From \refrule{tm-cast} we deduce that there exist $S, T, \Ctx', n', m_u$ such that
\begin{itemize}
\item $\Ctx = \Ctx', u : S$
\item $S \subt[m_u] T$
\item $n = m_u + n'$
\item $\wtp[n']{\Ctx', u : T}{P'}$
\end{itemize}
Using the induction hypothesis on $\wtp[n']{\Ctx', u : T}{P'}$ and $P' \red Q'$ we deduce $\wtp[m']{\Ctx', u : T}{Q'}$ for some $m'$.
We conclude with an application of \refrule{tm-cast} taking $m \eqdef m_u + m'$.

\proofrule{rm-struct}
%
Then $P \pcong P' \red Q' \pcong Q$.
%
From \Cref{lem:subj_cong_multi} we deduce that $\wtp[n']{\Ctx}{P'}$ for some $n' \le n$.
Using the induction hypothesis on $\wtp[n']{\Ctx}{P'}$ and $P' \red Q'$ we deduce $\wtp[m']{\Ctx}{Q'}$ for some $m'$. 
We conclude using \cref{lem:subj_cong_multi} once more.
\end{proof}