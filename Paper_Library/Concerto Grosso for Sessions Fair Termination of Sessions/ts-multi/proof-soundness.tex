\beginbass
%
The next key result we prove is inspired by the \emph{helpful direction}. Given a well typed process in
proximity normal form (see \Cref{def:pnf_multi}), we prove that there exists a reduct that is well typed
with a \emph{strictly smaller} measure (see \Cref{lem:pnf_helpful_direction_multi}). 
Notably, this result implies deadlock freedom.
%
Then, it is easy to prove that a well typed process is either $\pdone$ or it can reach $\pdone$ in finitely
many steps by induction over the measure.

\begin{lemma}
	\label{lem:pnf_helpful_direction_multi}
	If $\wtpn\Measure\Ctx\Pnf$ where $\Pnf$ is in proximity normal form, then there exist $Q$ and $\MeasureN < \Measure$ 
	such that $\Pnf \wred^+ Q$ and $\wtpn\MeasureN\Ctx{Q}$.
\end{lemma}
\begin{proof}
From the hypothesis that $\Pnf$ is in proximity normal form we know that 
$\Pnf = \PCtxC[\pres{s}{\Pth_1 \parop \cdots \parop \Pth_h}]$ for some $\PCtxC$, $s$ and $\Pth_1, \dots, \Pth_h$ $s$-threads.
We reason by induction on $\PCtxC$ and by cases on its shape.
	
\proofcase{Case $\PCtxC = \Hole$}
%
From \refrule{mtm-thread} and \refrule{mtm-par} we deduce that there exist $\Ctx_i, S_i, \role_i, n_i$ for $i=1,\dots,h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$
\item $\Measure = (\sum_{i=1}^h n_i , \rank{\prod_{i=1}^h \Map{\role_i}{S_i}})$
\item $\wtp[n_i]{\Ctx_i, \ep{s}{\role_i} : S_i}{\Pth_i}$ for $i=1,\dots,h$
\end{itemize}
From the hypothesis that $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$ we deduce $\prod_{i=1}^h \Map{\role_i}{S_i} \wlred{\In\terminated}$. 
We now reason on the rank of the session and on the shape of $S_i$. 
For the sake of simplicity, we implicitly apply \refrule{s-par-comm} at process level.\\\\
%
If $\rank{\prod_{i=1}^h \Map{\role_i}{S_i}} = 1$, then $\prod_{i=1}^h \Map{\role_i}{S_i} \lred{\In\terminated}$ using \refrule{lm-terminate}.
%
\begin{itemize}
\item \proofcase{Case $S_1 = \End[\In]$ and $S_j = \End[\Out]$ for $j=2,\dots,h$}
%
Then 
	\begin{itemize}
	\item $\Ctx_j = \EmptyCtx$ and $\Pth_j = \pclose{\ep{s}{\role_j}}$ for $j=2,\dots,h$
	\item $\Pth_1 = \pwait{\ep{s}{\role_1}}{Q}$
	\item $\wtp[n_1]{\Ctx_1}{Q}$
	\end{itemize}
From \Cref{lem:measure_rank_multi} we deduce that $\wtpn{\MeasureN}{\Ctx_1}{Q}$ for some $\MeasureN \le (n_1 , 0)$. 
We conclude observing that $\Pnf \red Q$ by \refrule{rm-signal} and that 
$\MeasureN \le (n_1 , 0) < (\sum_{i=1}^h n_i , \rank{\prod_{i=1}^h \Map{\role_i}{S_i}}) = \Measure$.
\end{itemize}
%
If $\rank{\prod_{i=1}^h \Map{\role_i}{S_i}} > 1$, then $\prod_{i=1}^h \Map{\role_i}{S_i} \lred{\tau} \dots \lred{\In\terminated}$ 
first using \refrule{lm-tau} and \refrule{lm-sync}. 
Observe that \refrule{lm-pick} is never used since we are considering the minimum reduction sequence; 
a synchronization through \refrule{lm-pick} and \refrule{lm-sync} would lead to a longer reduction. T
hen $S_1 \xlred{\Map{\role_1}{\role_2\Out\Tag_k}}$ and $S_2 \xlred{\Map{\role_2}{\role_1\In\Tag_k}}$ for some 
$\Tag_k$ or $S_1 \xlred{\Map{\role_1}{\role_2}\Out S}$ and $S_2 \xlred{\Map{\role_1}{\role_2}\In S}$.
%
\begin{itemize}
\item \proofcase{Case $S_1 = \Tags\role_2\Out \Tag_i.S'_i$ and $S_2 = \JTags\role_1\In \Tag_j.T_j$ with $k \in I$}
%
From the hypothesis that $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$ we deduce $I \subseteq J$. 
From \Cref{def:coherence} we deduce 
$\prod_{i = 3}^h \Map{\role_i}{S_i} \parop \Map{\role_1}{S'_{k}} \parop \Map{\role_2}{T_{k}} \ft$ 
and from \refrule{tm-tag} we deduce that 
	\begin{itemize}
	\item $\Pth_1 = \pbranch[i \in I]{\ep{s}{\role_1}}{\role_2}{\Out}{\Tag_i}{P'_i}$
	\item $\Pth_2 = \pbranch[j \in J]{\ep{s}{\role_2}}{\role_1}{\In}{\Tag_j}{Q_j}$
	\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role_1} : S'_i}{P'_i}$ for all $i \in I$
	\item $\wtp[n_2]{\Ctx_2, \ep{s}{\role_2} : T_j}{Q_j}$ for all $j \in J$
	\end{itemize}
Let $Q \eqdef \pres{s}{P'_k \parop Q_k \parop P_3 \parop \dots \parop P_h}$ and observe that $\Pnf \wred^+ Q$ by \refrule{rm-pick} and \refrule{rm-tag}. 
From \Cref{lem:measure_rank_multi} we deduce that there exist $\Measure_1 \le (n_1 , 0), \Measure_2 \le (n_2 , 0)$ such that
	\begin{itemize}
	\item $\wtpn{\Measure_1}{\Ctx_1, \ep{s}{\role_1} : S'_k}{P'_k}$
	\item $\wtpn{\Measure_2}{\Ctx_2, \ep{s}{\role_2} : T_k}{Q_k}$
	\end{itemize}
Let 
$\MeasureN \eqdef \Measure_1 
	+ \Measure_2 
	+ (\sum_{i=3}^h n_i, \rank{\Map{\role_1}{S'_k} \parop \Map{\role_2}{T_k} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})$. 
We conclude with one application of \refrule{mtm-par} observing that
\[
\begin{array}{rcll}
	\MeasureN & = & \Measure_1 + \Measure_2 + \\
	& & (\sum_{i=3}^h n_i, \rank{\Map{\role_1}{S'_k} \parop \Map{\role_2}{T_k} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})
	& \text{by def. of $\MeasureN$}
	\\
	& \le & (\sum_{i=1}^h n_i, \rank{\Map{\role_1}{S'_k} \parop \Map{\role_2}{T_k} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})
	& \text{by \Cref{lem:measure_rank_multi}}
	\\
	& < & (\sum_{i=1}^h n_i, \rank{\prod_{i=1}^h \Map{\role_i}{S_i}})
	& \text{before $\red$}
	\\
	& = & \Measure
\end{array}
\]
\end{itemize}
%
\begin{itemize}
\item \proofcase{Case $S_1 = \role_2\Out{S}.T_1$ and $S_2 = \role_1\In{S}.T_2$}
\end{itemize}
%
From the hypothesis that $\prod_{i=1}^h \Map{\role_i}{S_i} \ft$ and \Cref{def:coherence} we deduce 
$\Map{\role_1}{T_1} \parop \Map{\role_2}{T_2} \parop \prod_{i=3}^h \Map{\role_i}{S_i} \ft$ and from 
\refrule{tm-channel-out} and \refrule{tm-channel-in} we deduce that
	\begin{itemize}
	\item $\Pth_1 = \poch{\ep{s}{\role_1}}{\role_2}{u}{P'_1}$
	\item $\Pth_2 = \pich{\ep{s}{\role_2}}{\role_1}{x}{P'_2}$
	\item $\wtp[n_1]{\Ctx_1, \ep{s}{\role_1} : T_1}{P'_1}$
	\item $\wtp[n_2]{\Ctx_2, \ep{s}{\role_2} : T_2, x : S}{P'_2}$
	\end{itemize}
Let $Q \eqdef \pres{s}{P'_1 \parop P'_2\subst{u}{x} \parop \Pth_3 \parop \cdots \parop \Pth_h}$ and observe that $\Pnf \red Q$ by \refrule{rm-channel}. 
Using \Cref{lem:substitution_multi} we deduce $\wtp[n_2]{\Ctx_2, \ep{s}{\role_2} : T_2, u : S}{P'_2\subst{u}{x}}$ and 
from \Cref{lem:measure_rank_multi} we deduce that there exist $\Measure_1 \le (n_1 , 0), \Measure_2 \le (n_2 , 0)$ such that
	\begin{itemize}
	\item $\wtpn{\Measure_1}{\Ctx_1, \ep{s}{\role_1} : T_1}{P'_1}$
	\item $\wtpn{\Measure_2}{\Ctx_2, \ep{s}{\role_2} : T_2, u : S}{P'_2\subst{u}{x}}$
	\end{itemize}
Let $\MeasureN \eqdef \Measure_1 
	+ \Measure_2 
	+ (\sum_{i=3}^h n_i, \rank{\Map{\role_1}{T_1} \parop \Map{\role_2}{T_2} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})$. 
We conclude with one application of \refrule{mtm-par} observing that
\[
\begin{array}{rcll}
	\MeasureN & = & \Measure_1 + \Measure_2 + \\
	& & (\sum_{i=3}^h n_i, \rank{\Map{\role_1}{T_1} \parop \Map{\role_2}{T_2} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})
	& \text{by definition of $\MeasureN$}
	\\
	& \le & (\sum_{i=1}^h n_i, \rank{\Map{\role_1}{T_1} \parop \Map{\role_2}{T_2} \parop \prod_{i=3}^h \Map{\role_i}{S_i}})
	& \text{by \Cref{lem:measure_rank_multi}}
	\\
	& < & (\sum_{i=1}^h n_i, \rank{\prod_{i=1}^h \Map{\role_i}{S_i}}) 
	& \text{before reductions}
	\\
	& = & \Measure
\end{array}
\]

\proofcase{Case $\PCtxC = \pres{t}{\procs{\Ppar} \parop \PCtxD \parop \procs{\Qpar}}$}
%
Let $\Rnf \eqdef \PCtxD[\pres{s}{\Pth_1 \parop \dots \parop \Pth_h}]$ and observe that $\Rnf$ is in proximity normal form. 
From \refrule{mtm-par} we deduce that there exist $\Ctx_i, S_i, \Measure_i, \role_i$ for $i=1,\dots,h$ and $k \le h$ such that
\begin{itemize}
\item $\Ctx = \Ctx_1,\dots,\Ctx_h$
\item $\wtpn{\Measure_1}{\Ctx_1, \ep{t}{\role_1} : S_1}{\Rnf}$
\item $\wtpn{\Measure_i}{\Ctx_i, \ep{t}{\role_i} : S_i}{\Ppar_i}$ for $i=1,\dots,k$
\item $\wtpn{\Measure_i}{\Ctx_i, \ep{t}{\role_i} : S_i}{\Qpar_i}$ for $i=k+1,\dots,h$
\item $\Measure = \sum_{i=1}^h \Measure_i + (0 , \rank{\prod_{i=1}^h \Map{\role_i}{S_i}})$
\end{itemize}
Using the induction hypothesis on $\wtpn{\Measure_1}{\Ctx_1, \ep{t}{\role_1} : S_1}{\Rnf}$ we deduce that there 
exists $Q'$ and $\MeasureN' < \Measure_1$ such that
\begin{itemize}
\item $\Rnf \wred^+ Q'$
\item $\wtpn{\MeasureN'}{\Ctx_1, \ep{t}{\role_1} : S_1}{Q'}$
\end{itemize}
We conclude taking $Q \eqdef \pres{t}{Q' \parop \procs\Ppar \parop \procs\Qpar}$ and
\[
	\MeasureN \eqdef \MeasureN' + \sum_{i=2}^h \Measure_i + (0 , \rank{\prod_{i=1}^h \Map{\role_i}{S_i}})
\] 
and observing that $\MeasureN < \Measure$ and $\Pnf \wred^+ Q$ by \refrule{rm-par}.

\proofcase{Case $\PCtxC = \pcast{\ep{t}{\roleq}}{\PCtxD}$}
%
Observe that $t \ne s$. Let $\Rnf \eqdef \PCtxD[\pres{s}{\Pth_1 \parop \cdots \parop \Pth_h}]$ 
and note that $\Rnf$ is in proximity normal form. 
From \refrule{mtm-cast} we deduce that there exists $\CtxD, \Measure', S, T, m_t$ such that
\begin{itemize}
\item $\Ctx = \CtxD, \ep{t}{\roleq} : S$
\item $S \subt[m_t] T$
\item $\Measure = \Measure' + (m_t,0)$
\item $\wtpn{\Measure'}{\CtxD, \ep{t}{\roleq} : T}{\Rnf}$
\end{itemize}
Using the induction hypothesis on $\wtpn{\Measure'}{\CtxD, \ep{t}{\roleq} : T}{\Rnf}$ we deduce that 
there exist $Q'$ and $\MeasureN' < \Measure'$ such that $\Rnf \wred^+ Q'$ and $\wtpn{\MeasureN'}{\CtxD, \ep{t}{\roleq} : T}{Q'}$. 
We conclude taking $Q \eqdef \pcast{\ep{t}{\roleq}}{Q'}$ and $\MeasureN \eqdef \MeasureN' + (m_t , 0)$ 
and observing that $\MeasureN < \Measure$ and $\Pnf \wred^+ Q$ by \refrule{rm-cast}.
\end{proof}

\begin{lemma}
	\label{lem:helpful_direction_multi}
	If $\wtpn{\Measure}{\EmptyCtx}{P}$, then either $P \pcong \pdone$ or $P \wred^+ Q$ 
	and $\wtpn{\MeasureN}{\EmptyCtx}{Q}$ for some $Q$ and $\MeasureN < \Measure$.
\end{lemma}
\begin{proof}
Using \Cref{lem:cnf_exists_multi} we deduce that there exist $P'$ in choice normal form such that
$P \wred P'$ and $\wtpn{\MeasureM'}\EmptyCtx{P'}$ and $\MeasureM' \leq \MeasureM$.
By \Cref{lem:measure_rank_multi} we deduce $\wtp\EmptyCtx{P'}$. 
Using \Cref{lem:tnf_exists_multi} we deduce that there exist $\Pnf$ such that $P' \pcong \Pnf$.

If $\Pnf = \pdone$ there is nothing left to prove.

If $\Pnf \neq \pdone$, by \Cref{lem:dl_freedom_multi} we deduce $\Pnf \pcong \Qnf$ for some $\Qnf$ in proximity normal form.
From \Cref{lem:measure_pcong_multi} we deduce $\wtpn{\MeasureM''}\EmptyCtx\Qnf$ for some $\MeasureM'' \leq \MeasureM'$.
Using \Cref{lem:pnf_helpful_direction_multi} we conclude that $\Qnf \wred^+ Q$ and $\wtpn\MeasureN\EmptyCtx Q$ 
for some $Q$ and $\MeasureN < \MeasureM'' \leq \MeasureM' \leq \MeasureM$.
\end{proof}

\begin{lemma}
	\label{lem:weak_termination_multi}
	If $\wtp[n]\EmptyCtx{P}$, then either $P \pcong \pdone$ or $P \wred^+ \pdone$.
\end{lemma}
\begin{proof}
From \Cref{lem:measure_rank_multi} we deduce that there exists $\MeasureM \le (n,0)$ such that $\wtpn\MeasureM\EmptyCtx P$.
We proceed doing an induction on the lexicographically ordered pair $\MeasureM$.
%
From \Cref{lem:helpful_direction_multi} we deduce either $P \pcong \pdone$ or $P \wred^+ Q$ 
and $\wtpn\MeasureN\EmptyCtx{Q}$ for some $\MeasureN < \MeasureM$.
%
In the first case there is nothing left to prove.
%
In the second case we use the induction hypothesis to deduce that either $Q \pcong \pdone$ or $Q \wred^+ \pdone$.
%
We conclude using either \refrule{rm-struct} or the transitivity of $\wred^+$, respectively.
\end{proof}

\begin{proof}[Proof of \Cref{thm:ts_multi_sound}]
	\brk
	Immediate consequence of \Cref{lem:subj_red_multi,lem:weak_termination_multi}.
\end{proof}