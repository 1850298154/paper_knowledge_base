{
\begin{algorithm}[t!]
\caption{Denoising Optimization Process}
\label{algo:mbd}
%
\begin{algorithmic}[1]
\small
\State $U_N \sim \mathcal{N}(\bm{0}, I)$
\label{algo:mbd:init}
\Comment{initialize control trajectory}
%
\For{$i \gets N~\text{to}~1$}
\State Sample $M$ control trajectories:
\begin{align*}
\Gamma_u \sim
  \mathcal{N} \left( \frac{U_i}{\sqrt{\bar{\alpha}_i}}, \left( \frac{1}{\bar{\alpha}_i} - 1 \right) I \right)
\end{align*}\;
\label{algo:mbd:sample}
%
\State Sample $M$ trajectories:
$\Gamma \leftarrow \texttt{rollout}\left(\mathcal{S}, \Gamma_u \right)$
\label{algo:mbd:rollout}
%
\State Compute Monte Carlo estimation:
\begin{align*}
\bar{U} \leftarrow \frac
{\sum_{\tau \in \Gamma} p_0(\tau) (\tau.u)}
{\sum_{\tau \in \Gamma} p_0(\tau)}, \:
p_0(\tau) \approx \exp\left(\frac{r(\tau)}{\lambda}\right)
\end{align*}
\label{algo:mbd:mc}
%
\State Perform one-step denoising:
$U_{i-1} \leftarrow \sqrt{\bar{\alpha}_{i-1}} \: \bar{U}$
\label{algo:mbd:denoising}
%
\EndFor
%
\State \Return $\texttt{rollout}\left( \mathcal{S}, U_0 \right)$
\label{algo:mbd:final}
%
\end{algorithmic}
\end{algorithm}
}
