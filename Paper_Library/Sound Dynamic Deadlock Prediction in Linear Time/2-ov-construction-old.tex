%!TEX root = main.tex


\begin{proof}
	We show a fine-grained reduction from the Orthogonal Vectors Problem to
	the problem of checking for deadlock patterns of size $2$.
	For this, we start with two sets
	$A, B \subseteq \set{0, 1}^d$
	of $d$-dimensional vectors with $|A| = |B| = n$.
	We write the $i^{th}$ vector in $A$ as $A_i$ and that in $B$ as $B_i$.
	
	%\input{figures/construction-ov-hardness}
	
	\myparagraph{Construction}{
		We will construct a trace $\tr$ such that $\tr$ has a deadlock
		pattern of length $2$ iff $(A, B)$ is a positive OV instance.
		The trace $\tr$ is of the form $\tr = \tr^A \cdot \tr^B$
		and uses $2$ threads $\set{t_A, t_B}$ and $d+2$ distinct locks $\lk_1, \ldots, \lk_d, m_0, m_1$. 
		Intuitively, $\tr^A$ and $\tr^B$  encode the given sets of vectors $A$ and $B$.
		The sub-traces $\tr^A = \tr^A_1 \cdot \tr^A_2 \cdots \tr^A_n$
		and $\tr^B = \tr^B_1 \cdot \tr^B_2 \cdots \tr^B_n$ are defined as follows.
		For each $i \in \set{1, 2, \ldots, n}$ and $Z \in \set{A, B}$, the
		sub-trace $\tr^Z_i$ is the unique string generated by the
		grammar having $d+1$ non-terminals $S_0, S_1, \ldots, S_d$, start symbol $S_d$
		and the following production rules:
		\begin{itemize}
			\item $S_0 \to \ev{t_Z, \acq(m)} \cdot \ev{t_Z, \acq(m')} \cdot \ev{t_Z, \rel(m')} \cdot \ev{t_Z, \rel(m)}$,
			where $(m, m') = (m_0, m_1)$ if $Z = A$, and $(m, m') = (m_1, m_0)$.
			\item for each $1 \leq j \leq d$, $S_j \to S_{j-1}$ if $Z_i[j] = 0$.
			Otherwise (if $Z_i[j] =1$), $S_j \to \ev{t_Z, \acq(\lk_j)} \cdot S_{j-1} \cdot \ev{t_Z, \rel(\lk_j)}$.
		\end{itemize}
		In words, all events of $\tr^A$ are performed by thread $t_A$ and those
		in $\tr^B$ are performed by $t_B$.
		Next, the $i^{th}$ sub-trace of $\tr^A$, denoted $\tr^A_i$ corresponds to the vector $A_i$
		as follows --- $\tr^A_i$ is a nested block of critical sections,
		with the innermost critical section being on lock $\lk'$,
		which is immediately enclosed in a  critical section on lock $\lk$.
		Further, in the sub-trace $\tr^A_i$, the lock $\lk_j$
		occurs iff $A_i[j] = 1$.
		The sub-traces $\tr^B_i$ is similarly constructed, except that the order
		of the two innermost critical sections is inverted.
		\figref{ov-hardness} illustrates the construction for an OV-instance with $n=2$ and $d=2$.}
\end{proof}
