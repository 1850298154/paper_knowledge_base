%!TEX root = main.tex

\begin{proof}
	We show a fine-grained reduction from the Orthogonal Vectors Problem to
	the problem of checking for deadlock patterns of size $k$.
	For this, we start with two sets
	$A_1, A_2, \ldots, A_k \subseteq \set{0, 1}^d$
	of $d$-dimensional vectors with $|A_i| = n$ for every $1 \leq i \leq k$.
	We write the $j^{th}$ vector in $A_i$ as $A_{i, j}$.
	
	%\input{figures/construction-ov-hardness}
	
	\myparagraph{Construction}{
		We will construct a trace $\tr$ such that $\tr$ has a deadlock
		pattern of length $k$ iff $(A_1, A_2, \ldots, A_k)$ is a positive $k$-OV instance.
		The trace $\tr$ is of the form $\tr = \tr^{A_1} \cdot \tr^{A_2} \cdots \tr^{A_k}$
		and uses $k$ threads $\set{t_{A_1}, \ldots, t_{A_k}}$ and $d+k$ distinct 
		locks $\lk_1, \ldots, \lk_d, m_1, m_2, \ldots, m_k$. 
		Intuitively, the sub-trace $\tr^{A_i}$ encodes the given set of vectors $A_i$.
		The sub-traces $\tr^{A_i} = \tr^{A_i}_1 \cdot \tr^{A_i}_2 \cdots \tr^{A_i}_n$
		% and $\tr^B = \tr^B_1 \cdot \tr^B_2 \cdots \tr^B_n$ 
		are defined as follows.
		For each $j \in \set{1, 2, \ldots, n}$
		the sub-trace $\tr^{A_i}_j$ is the unique string generated by the
		grammar having $d+1$ non-terminals $S_0, S_1, \ldots, S_d$, start symbol $S_d$
		and the following production rules:
		\begin{itemize}
			\item $S_0 \to \ev{t_Z, \acq(m_i)} \cdot \ev{t_Z, \acq(m_{i \% k + 1})} \cdot \ev{t_Z, \rel(m_{i \% k + 1})} \cdot \ev{t_Z, \rel(m_i)}$.
			% where $(m, m') = (\lk, \lk')$ if $Z = A$, and $(m, m') = (\lk', \lk)$.
			\item for each $1 \leq p \leq d$, $S_p \to S_{p-1}$ if $A_{i, j}[p] = 0$.
			Otherwise (if $A_{i, j}[p] =1$), $S_p \to \ev{t_{A_i}, \acq(\lk_p)} \cdot S_{p-1} \cdot \ev{t_{A_i}, \rel(\lk_p)}$.
		\end{itemize}
		In words, all events of $\tr^{A_i}$ are performed by thread $t_{A_i}$.
		 % and those in $\tr^B$ are performed by $t_B$.
		Next, the $j^{th}$ sub-trace of $\tr^{A_i}$, denoted $\tr^{A_i}_j$ corresponds to the vector $A_{i, j}$
		as follows --- $\tr^{A_i}_j$ is a nested block of critical sections,
		with the innermost critical section being on lock $m_{i \% k + 1}$,
		which is immediately enclosed in a  critical section on lock $m_i$.
		Further, in the sub-trace $\tr^{A_i}_j$, 
		the lock $\lk_p$ occurs iff $A_{i, j}[p] = 1$.
		% The sub-traces $\tr^B_i$ is similarly constructed, except that the order
		% of the two innermost critical sections is inverted.
		\figref{ov-hardness} illustrates the construction for an OV-instance with $k=2$ $n=2$ and $d=2$.
	}
\end{proof}
