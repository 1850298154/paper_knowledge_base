%!TEX root = main.tex

%\subsection{$\W{1}$-hardness for Detecting Deadlock Patterns}
\subsection{Proof of \thmref{pattern-w1-hardness-pattern}}
\seclabel{w1-hardness-pattern}

Checking whether a trace of length
$\NumEvents$ has a deadlock pattern of size $k$
can be solved using a simple enumeration based algorithm
in time $O(\poly{\NumThreads} \cdot \NumEvents^\NumThreads)$.
In this section, we show that this problem is, in fact,
$\W{1}$-hard
% \footnote{We remark that $\W{1}$-hardness in a parameter also implies $\NP$-hardness in general} in the parameter $k$,
and thus is unlikely to be FPT (fixed parameter tractable).
In other words, an algorithm with running time $O(f(\NumThreads) \cdot \poly{\NumEvents})$ 
is unlikely to exist for this problem, for any computable function $f$.
%We now state our result.



\patternwonehardness*
\begin{proof}
	We show that there is a polynomial-time FPT-reduction from
	INDEPENDENT-SET(c) to the problem of checking the existence of deadlock-patterns
	of size $c$.
	Our reduction takes as input an undirected graph $G$ and outputs a trace $\tr$
	such that $G$ has an independent set of size $c$ iff $\tr$
	has a deadlock pattern of size $c$.
	%Here present the construction and refer to \appref{proofs} for the proof of correctness.
	
% 	\begin{figure}[]
% 		\input{figures/construction-w1-hardness}
% 		\hfill ~ \unskip\ \vrule\ \hfill \input{figures/construction-ov-hardness}
% 		\caption{
% 		Construction of $\W{1}$-hardness (\subref{fig:w1-hardness}) and OV-hardness (\subref{fig:ov-hardness}) results. 
% 		We use the shortcut $\cs(\lk_i,\lk_j)$ to denote two nested critical sections on $\lk_i$ and $\lk_j$. That is,
% 	$\cs(\lk_i,\lk_j)=\acq(\lk_i) \cdot\acq(\lk_j) \cdot\rel(\lk_j) \cdot \rel(\lk_i)$.
% 		} 
% 		%\label{fig:main}
% 	\end{figure}


	\myparagraph{Construction}{
		%Let $G = (V, E)$ be the input graph and let $c$ be the parameter.
		We assume  that the vertices are indexed from $1$ through $n = |V|$: $V = \set{v_1, v_2, \ldots, v_n}$.
		We also assume a total ordering $<_E$ on the set of edges $E$.
		The trace $\tr$ we construct is a concatenation of $c$ sub-traces: 
		$
		\tr = \tr^{(1)} \cdot \tr^{(2)} \cdots \tr^{(c)}
		$
		and uses $c$ threads $\set{t_1, t_2, \ldots t_c}$ and
		$|E| + c$ locks $\set{\lk_{\set{u, v}}}_{\set{u, v} \in E} \uplus \set{\lk_0, \lk_1 \ldots, \lk_{c-1}}$.
		The $i^\text{th}$ sub-trace $\tr^{(i)}$ is a sequence of events performed by thread $t_i$, and
		is obtained by concatenation of $n = |V|$ sub-traces:
		$
		\tr^{(i)} = \tr^{(i)}_1 \cdot \tr^{(i)}_2 \cdots \tr^{(i)}_n
		$.
		Each sub-trace $\tr^{(i)}_j$ with $(i \leq c, j \leq n)$ 
		comprises of nested critical sections over locks of the 
		form $\lk_{\set{v_j, u}}$, where $u$ is a neighbor of $v_j$.
		Inside the nested block we have critical 
		sections on locks $\lk_{i \% c}$ and $\lk_{(i+1) \% c}$.
		Formally, let $\set{v_j, v_{k_1}}, \ldots, \set{v_j, v_{k_d}}$
		be the neighboring edges of $v_j$ (ordered according to $<_E$).
		Then, $\tr^{(i)}_j$ is the unique string generated by the
		grammar having $d+1$ non-terminals $S_0, S_1, \ldots, S_d$, start symbol $S_d$
		and the following production rules:
		\begin{itemize}
			\item $S_0 \to \ev{t_i, \acq(\lk_{i \% c})} \cdot \ev{t_i, \acq(\lk_{(i+1) \% c})} \cdot \ev{t_i, \rel(\lk_{(i+1) \% c})} \cdot \ev{t_i, \rel(\lk_{i \% c})}$.
			\item for each $1 \leq r \leq d$, $S_r \to \ev{t_i, \acq(\lk_{\set{v_j, v_{k_r}}})} \cdot S_{r-1} \cdot \ev{t_i, \rel(\lk_{\set{v_j, v_{k_r}}})}$.
		\end{itemize}
		\figref{w1-hardness} illustrates this construction for a graph with $3$ nodes
		and parameter $c = 3$.
		Finally, observe that the lock-nesting depth in $\tr$ is bounded by 2 + the degree of $G$.
	}
	
\myparagraph{Correctness}{
	We now argue for the correctness of the construction.
	First, consider the case when $G$ has an independent set $I = \set{v_{j_1}, \ldots v_{j_c}}$ of size $\geq c$.
	Let  be $c$ distinct vertices from the independent set.
	Let $e^{(i)}_{j}$ be the innermost acquire (on lock $\lk_{(i+1) \% c}$) in the sub-trace 
	$\tr^{(i)}_{j}$.
	We show that the sequence $D = \pattern{e^{(1)}_{j_1}, e^{(2)}_{j_2} \ldots, e^{(c)}_{j_c}}$ 
	is a deadlock pattern.
	Observe that $\ThreadOf{e^{(i)}_{j_i}} = t_i \neq t_{i'} = \ThreadOf{e^{(i')}_{j_{i'}}}$ for every $i \neq i'$.
	Similarly, the locks acquired in $e^{(i)}_{j_i}$ and $e^{(i')}_{j_{i'}}$ are also distinct
	when $i \neq i'$.
	Finally, we want to show that $\lheld{\tr}(e^{(i)}_{j_i}) \cap \lheld{\tr}(e^{(i')}_{j_{i'}}) = \emptyset$ for every $i \neq i'$.
	Assume on the contrary that there is a lock $\lk \in \lheld{\tr}(e^{(i)}_{j_i}) \cap \lheld{\tr}(e^{(i')}_{j_{i'}})$.
	Clearly, $\lk$ cannot be of the form $\lk_m$ for some $0 \leq m < c$ as the only such lock held
	at $e^{(i)}_{j_i}$ is $\lk_{i \% c}$ and the only such lock held at $e^{(i')}_{j_{i'}}$ is $\lk_{i' \% c}$
	which are different.
	Thus, it must be of the form $\lk_{\set{u, v}}$ for some $\set{u, v} \in E$.
	Since it is acquired in both sub-traces  $\tr^{(i)}_{j_i}$ and $\tr^{(i')}_{j_{i'}}$,
	we have $\lk = \lk_{\set{v_i, v_{i'}}}$.
	This means that $\set{v_i, v_{i'}} \in E$ contradicting that $I$ is an independent set.

	Now, consider the case when there is a deadlock pattern of size $c$:
	$D = \pattern{e_0, e_1, \ldots, e_{c-1}}$.
	Since there are exactly $c$ threads in $\tr$, there must be one event in each thread.
	We first argue that if there is one $e_i$ that acquires a lock of the form $\lk_{\set{u, v}}$ then all events in the deadlock pattern do so.
	This follows from a simple inductive argument --- $e_{i+1}$ must acquire a lock held at $e_i$
	and thus must be of the form $\lk_{\set{u', v'}}$, and so on.
	Next, all locks of the form $\lk_{\set{u, v}}$ are acquired in the order consistent with
	the total order $<_E$.
	Hence, they cannot form a cyclic dependency.
	Thus, the locks acquired at $e_0, \ldots e_{c-1}$ are $\lk_0, \ldots, \lk_{c-1}$.
	Symmetry ensures that, you can assume, w.l.o.g that $\OpOf{e_i} = \acq(\lk_{i \% c})$.
	Let $f(i)$ be the index such that $e_i$ is in the subtrace $e^{(i)}_{f(i)}$.
	Then, we show that the set $A = \set{v_{f(1)}, v_{f(2)}, \ldots, v_{f(c)}}$ is an independent set of size $c$.
	Assume on the contrary that there are $i \neq i'$ such that $\set{v_{f(i)}, v_{f(i')}} \in E$.
	Then, our construction ensures that
	the lock $\lk_\set{v_{f(i)}, v_{f(i')}}$ will be held at both $e_i$ and $e_{i'}$
	contradicting that $D$ is a deadlock pattern.
}	

\myparagraph{Time complexity}{
		%Let us assume that the graph $G$ is presented as an adjacency list.
		The size of the trace is $O\big(c \cdot (2 + \sum_{v \in V} \mathsf{degree}(v)) \big)$
		$ = O(c \cdot (|V| + |E|))$
		and the time taken is also the same.
		%Also, the parameter $c$ is the same in both problems.
	}
\end{proof}





