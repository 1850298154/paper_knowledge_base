%!TEX root = main.tex

\subsection{Proof of \thmref{pattern-ov-hardness}}
\seclabel{ov-hardness}




\patternovhardness*
\begin{proof}
	
	We show a fine-grained reduction from the Orthogonal Vectors Problem to
	the problem of checking for deadlock patterns of size $k$.
	For this, we start with two sets
	$A_1, A_2, \ldots, A_k \subseteq \set{0, 1}^d$
	of $d$-dimensional vectors with $|A_i| = n$ for every $1 \leq i \leq k$.
	We write the $j^{th}$ vector in $A_i$ as $A_{i, j}$.
	
	%\input{figures/construction-ov-hardness}
	
	\myparagraph{Construction}{
		We will construct a trace $\tr$ such that $\tr$ has a deadlock
		pattern of length $k$ iff $(A_1, A_2, \ldots, A_k)$ is a positive $k$-OV instance.
		The trace $\tr$ is of the form $\tr = \tr^{A_1} \cdot \tr^{A_2} \cdots \tr^{A_k}$
		and uses $k$ threads $\set{t_{A_1}, \ldots, t_{A_k}}$ and $d+k$ distinct 
		locks $\lk_1, \ldots, \lk_d, m_1, m_2, \ldots, m_k$. 
		Intuitively, the sub-trace $\tr^{A_i}$ encodes the given set of vectors $A_i$.
		The sub-traces $\tr^{A_i} = \tr^{A_i}_1 \cdot \tr^{A_i}_2 \cdots \tr^{A_i}_n$
		% and $\tr^B = \tr^B_1 \cdot \tr^B_2 \cdots \tr^B_n$ 
		are defined as follows.
		For each $j \in \set{1, 2, \ldots, n}$
		the sub-trace $\tr^{A_i}_j$ is the unique string generated by the
		grammar having $d+1$ non-terminals $S_0, S_1, \ldots, S_d$, start symbol $S_d$
		and the following production rules:
		\begin{itemize}
			\item $S_0 \to \ev{t_Z, \acq(m_i)} \cdot \ev{t_Z, \acq(m_{i \% k + 1})} \cdot \ev{t_Z, \rel(m_{i \% k + 1})} \cdot \ev{t_Z, \rel(m_i)}$.
			% where $(m, m') = (\lk, \lk')$ if $Z = A$, and $(m, m') = (\lk', \lk)$.
			\item for each $1 \leq p \leq d$, $S_p \to S_{p-1}$ if $A_{i, j}[p] = 0$.
			Otherwise (if $A_{i, j}[p] =1$), $S_p \to \ev{t_{A_i}, \acq(\lk_p)} \cdot S_{p-1} \cdot \ev{t_{A_i}, \rel(\lk_p)}$.
		\end{itemize}
		In words, all events of $\tr^{A_i}$ are performed by thread $t_{A_i}$.
		 % and those in $\tr^B$ are performed by $t_B$.
		Next, the $j^{th}$ sub-trace of $\tr^{A_i}$, denoted $\tr^{A_i}_j$ corresponds to the vector $A_{i, j}$
		as follows --- $\tr^{A_i}_j$ is a nested block of critical sections,
		with the innermost critical section being on lock $m_{i \% k + 1}$,
		which is immediately enclosed in a  critical section on lock $m_i$.
		Further, in the sub-trace $\tr^{A_i}_j$, 
		the lock $\lk_p$ occurs iff $A_{i, j}[p] = 1$.
		% The sub-traces $\tr^B_i$ is similarly constructed, except that the order
		% of the two innermost critical sections is inverted.
		\figref{ov-hardness} illustrates the construction for an OV-instance with $k=2$ $n=2$ and $d=2$.
	}

\myparagraph{Correctness}{
We now argue for the correctness of the construction.
First, if $(A_1, A_2, \ldots, A_k)$ is a positive $OV$ instance, then
there are $k$ indices $\alpha_1, \alpha_2, \ldots, \alpha_k \in \set{1 ,\ldots, n}$
such that $\sum_{p=1}^d \prod_{i=1}^k A_{i, \alpha_i}[p] = 0$.
 % and $B_\beta$ are orthogonal.
Thus, for every $1 \leq p \leq d$, there is an $i$ such that $A_{i, \alpha_i}[p] = 0$.
% or $B_\beta[j] = 0$.
Based on the construction, this implies that for every lock $\lk_p$
(with $1 \leq p \leq d$),
$\lk_p$ occurs in at most one of the sub-traces $\tr^{A_1}_{\alpha_1}, \ldots, \tr^{A_k}_{\alpha_k}$.
 % and $\tr^B_\beta$.
This gives a deadlock pattern $D = \pattern{e_1, e_2, \ldots, e_k}$,
where $e_i$ is the unique event in the sub-trace $\tr^{A_i}_{\alpha_i}$ with $\OpOf{e} = \acq(m_{i\%k +1})$.
% and $e'$ is the unique event in $\tr^B_\beta$ with $\OpOf{e'} = \acq(\lk)$.
This is because $m_i \in \lheld{\tr}(e_i)$,
and each lock $\lk_p$ exists in at most one of $\set{\lheld{\tr}(e_i)}_{i\leq n}$
% or $\lheld{\tr}(e')$ 
(and thus $\lheld{\tr}(e_i) \cap \lheld{\tr}(e_{i'}) = \emptyset$ for every $i \neq i' \leq n$).

Now, consider the case when there is a deadlock pattern $D = \pattern{e_1, e_2, \ldots, e_k}$ in $\tr$.
W.l.o.g, we can assume that
$\ThreadOf{e_i} = t_{A_i}$.
This means there are $\alpha_1, \alpha_2, \ldots, \alpha_k$
 % and $\beta$ such that
 such that
$e_i$ occurs in $\tr^{A_i}_{\alpha_i}$.
 % and $e'$ occurs in $\tr^B_\beta$.
Next, observe that the events $\set{e_i}_{i \leq k}$
 % and $e'$ 
 can only be acquire events on locks $\set{m_1, m_2, \ldots, m_k}$
and not on the locks $\set{\lk_1, \ldots, \lk_d}$.
This is because the order of acquisition amongst $\lk_1, \ldots, \lk_d$
is always fixed and further, each of these are never acquired inside of critical sections
of $m_1, \ldots, m_k$.
 % or $\lk'$.
By the choice of threads, $\OpOf{e_i} = \acq(m_{i\%k + 1})$ for every $i \leq k$.
% and $\OpOf{e'} = \acq(\lk)$.
Since $\lheld{\tr}(e_i) \cap \lheld{\tr}(e_{i'}) = \emptyset$ for every $i \neq i' \leq k$, 
we also have that
for every $p \leq d$, $\lk_p \not\in \lheld{\tr}(e) \cap \lheld{\tr}(e')$.
This means that at, for each $p \leq d$, there is atmost one $i \leq k$
for which $A_{i, \alpha_i}[p] = 1$.
This means that the vectors $A_{1, \alpha_1}, A_{2, \alpha_2} \ldots, A_{k, \alpha_k}$
witness that the given OV instance is a positive instance.
}


	\myparagraph{Time complexity}{
		For any fixed $k\geq 2$, the total size of the trace is $\NumEvents = O(n\cdot d)$
		and it has $\NumLocks = d + k $ locks.
		The construction can be performed in time $O(n\cdot d)$.
		Thus, if for some $\epsilon > 0$, 
		there is a $O(\poly{\NumLocks} \cdot \NumEvents^{k-\epsilon}) = O(\poly{d} \cdot n^{k-\epsilon})$ 
		algorithm for the problem of detecting deadlock patterns of length $k$,
		we would get a $O(\poly{d} \cdot n^{k-\epsilon} + n\cdot d) = O(\poly{d} \cdot n^{k-\epsilon})$
		time algorithm for $k$-OV, falsifying the $k$-OV hypothesis.
	}
\end{proof}
